commit 365c2d361a6fb0afda7ca12725297e6bbcc9a9a9
Author: 小傅哥 <184172133@qq.com>
Date:   Sat Apr 20 16:56:26 2024 +0800

    feat：第21节：活动信息API迭代和功能完善

diff --git a/.gitignore b/.gitignore
index 63c778b..946019f 100644
--- a/.gitignore
+++ b/.gitignore
@@ -39,3 +39,4 @@ build/
 /data/
 /.idea/
 /docs/dev-ops/log/
+/big-market-app/data/
diff --git a/big-market-api/src/main/java/cn/bugstack/trigger/api/dto/RaffleAwardListRequestDTO.java b/big-market-api/src/main/java/cn/bugstack/trigger/api/dto/RaffleAwardListRequestDTO.java
index e84e5ed..55d972e 100644
--- a/big-market-api/src/main/java/cn/bugstack/trigger/api/dto/RaffleAwardListRequestDTO.java
+++ b/big-market-api/src/main/java/cn/bugstack/trigger/api/dto/RaffleAwardListRequestDTO.java
@@ -10,7 +10,9 @@ import lombok.Data;
 @Data
 public class RaffleAwardListRequestDTO {
 
-    // 抽奖策略ID
-    private Long strategyId;
+    // 用户ID
+    private String userId;
+    // 抽奖活动ID
+    private Long activityId;
 
 }
diff --git a/big-market-api/src/main/java/cn/bugstack/trigger/api/dto/RaffleAwardListResponseDTO.java b/big-market-api/src/main/java/cn/bugstack/trigger/api/dto/RaffleAwardListResponseDTO.java
index e7653a7..14f82d5 100644
--- a/big-market-api/src/main/java/cn/bugstack/trigger/api/dto/RaffleAwardListResponseDTO.java
+++ b/big-market-api/src/main/java/cn/bugstack/trigger/api/dto/RaffleAwardListResponseDTO.java
@@ -24,5 +24,11 @@ public class RaffleAwardListResponseDTO {
     private String awardSubtitle;
     // 排序编号
     private Integer sort;
+    // 奖品次数规则 - 抽奖N次后解锁，未配置则为空
+    private Integer awardRuleLockCount;
+    // 奖品是否解锁 - true 已解锁、false 未解锁
+    private Boolean isAwardUnlock;
+    // 等待解锁次数 - 规定的抽奖N次解锁减去用户已经抽奖次数
+    private Integer waitUnLockCount;
 
 }
diff --git a/big-market-app/src/main/resources/mybatis/mapper/raffle_activity_account_day_mapper.xml b/big-market-app/src/main/resources/mybatis/mapper/raffle_activity_account_day_mapper.xml
index adcd7bf..858650c 100644
--- a/big-market-app/src/main/resources/mybatis/mapper/raffle_activity_account_day_mapper.xml
+++ b/big-market-app/src/main/resources/mybatis/mapper/raffle_activity_account_day_mapper.xml
@@ -32,4 +32,10 @@
         where user_id = #{userId} and activity_id = #{activityId} and day = #{day}
     </select>
 
+    <select id="queryRaffleActivityAccountDayPartakeCount" parameterType="cn.bugstack.infrastructure.persistent.po.RaffleActivityAccountDay" resultType="java.lang.Integer">
+        select day_count - day_count_surplus
+        from raffle_activity_account_day
+        where user_id = #{userId} and activity_id = #{activityId} and day = #{day}
+    </select>
+
 </mapper>
diff --git a/big-market-app/src/main/resources/mybatis/mapper/rule_tree_node_mapper.xml b/big-market-app/src/main/resources/mybatis/mapper/rule_tree_node_mapper.xml
index 57be387..940b4d3 100644
--- a/big-market-app/src/main/resources/mybatis/mapper/rule_tree_node_mapper.xml
+++ b/big-market-app/src/main/resources/mybatis/mapper/rule_tree_node_mapper.xml
@@ -18,4 +18,13 @@
         where tree_id = #{treeId}
     </select>
 
+    <select id="queryRuleLocks" resultMap="dataMap">
+        select tree_id, rule_value
+        from rule_tree_node
+        where rule_key = 'rule_lock' and tree_id in
+        <foreach item="treeId" index="index" collection="array" open="(" separator="," close=")">
+            #{treeId}
+        </foreach>
+    </select>
+
 </mapper>
diff --git a/big-market-app/src/main/resources/mybatis/mapper/strategy_award_mapper.xml b/big-market-app/src/main/resources/mybatis/mapper/strategy_award_mapper.xml
index 4f9aea5..192a902 100644
--- a/big-market-app/src/main/resources/mybatis/mapper/strategy_award_mapper.xml
+++ b/big-market-app/src/main/resources/mybatis/mapper/strategy_award_mapper.xml
@@ -24,7 +24,7 @@
     </select>
 
     <select id="queryStrategyAwardListByStrategyId" parameterType="java.lang.Long" resultMap="dataMap">
-        select strategy_id, award_id, award_title, award_subtitle, award_count, award_count_surplus, award_rate, sort
+        select strategy_id, award_id, award_title, award_subtitle, award_count, award_count_surplus, award_rate, rule_models, sort
         from strategy_award
         where strategy_id = #{strategyId}
         order by sort asc
diff --git a/big-market-app/src/test/java/cn/bugstack/test/ApiTest.java b/big-market-app/src/test/java/cn/bugstack/test/ApiTest.java
index 270f75f..b79b8ea 100644
--- a/big-market-app/src/test/java/cn/bugstack/test/ApiTest.java
+++ b/big-market-app/src/test/java/cn/bugstack/test/ApiTest.java
@@ -18,7 +18,8 @@ public class ApiTest {
     @Test
     public void test() {
         RaffleAwardListRequestDTO requestDTO = new RaffleAwardListRequestDTO();
-        requestDTO.setStrategyId(1000001L);
+        requestDTO.setUserId("xiaofuge");
+        requestDTO.setActivityId(100301L);
         log.info(JSON.toJSONString(requestDTO));
     }
 
diff --git a/big-market-app/src/test/java/cn/bugstack/test/domain/strategy/LogicTreeTest.java b/big-market-app/src/test/java/cn/bugstack/test/domain/strategy/LogicTreeTest.java
index a16c33e..01d886b 100644
--- a/big-market-app/src/test/java/cn/bugstack/test/domain/strategy/LogicTreeTest.java
+++ b/big-market-app/src/test/java/cn/bugstack/test/domain/strategy/LogicTreeTest.java
@@ -96,7 +96,7 @@ public class LogicTreeTest {
 
         IDecisionTreeEngine treeEngine = defaultTreeFactory.openLogicTree(ruleTreeVO);
 
-        DefaultTreeFactory.StrategyAwardVO data = treeEngine.process("xiaofuge", 100001L, 100);
+        DefaultTreeFactory.StrategyAwardVO data = treeEngine.process("xiaofuge", 100001L, 100, null);
         log.info("测试结果：{}", JSON.toJSONString(data));
 
     }
diff --git a/big-market-app/src/test/java/cn/bugstack/test/infrastructure/RaffleActivityAccountDayDaoTest.java b/big-market-app/src/test/java/cn/bugstack/test/infrastructure/RaffleActivityAccountDayDaoTest.java
new file mode 100644
index 0000000..69b03eb
--- /dev/null
+++ b/big-market-app/src/test/java/cn/bugstack/test/infrastructure/RaffleActivityAccountDayDaoTest.java
@@ -0,0 +1,36 @@
+package cn.bugstack.test.infrastructure;
+
+import cn.bugstack.infrastructure.persistent.dao.IRaffleActivityAccountDayDao;
+import cn.bugstack.infrastructure.persistent.po.RaffleActivityAccountDay;
+import lombok.extern.slf4j.Slf4j;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+import org.springframework.boot.test.context.SpringBootTest;
+import org.springframework.test.context.junit4.SpringRunner;
+
+import javax.annotation.Resource;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 活动日账户DAO
+ * @create 2024-04-20 10:15
+ */
+@Slf4j
+@RunWith(SpringRunner.class)
+@SpringBootTest
+public class RaffleActivityAccountDayDaoTest {
+
+    @Resource
+    private IRaffleActivityAccountDayDao raffleActivityAccountDayDao;
+
+    @Test
+    public void test_queryRaffleActivityAccountDayPartakeCount() {
+        RaffleActivityAccountDay raffleActivityAccountDay = new RaffleActivityAccountDay();
+        raffleActivityAccountDay.setActivityId(100301L);
+        raffleActivityAccountDay.setUserId("xiaofuge");
+        raffleActivityAccountDay.setDay(raffleActivityAccountDay.currentDay());
+        Integer dayPartakeCount = raffleActivityAccountDayDao.queryRaffleActivityAccountDayPartakeCount(raffleActivityAccountDay);
+        log.info("测试结果:{}", dayPartakeCount);
+    }
+
+}
diff --git a/big-market-app/src/test/java/cn/bugstack/test/infrastructure/RuleTreeNodeDaoTest.java b/big-market-app/src/test/java/cn/bugstack/test/infrastructure/RuleTreeNodeDaoTest.java
new file mode 100644
index 0000000..932d4b1
--- /dev/null
+++ b/big-market-app/src/test/java/cn/bugstack/test/infrastructure/RuleTreeNodeDaoTest.java
@@ -0,0 +1,34 @@
+package cn.bugstack.test.infrastructure;
+
+import cn.bugstack.infrastructure.persistent.dao.IRuleTreeNodeDao;
+import cn.bugstack.infrastructure.persistent.po.RuleTreeNode;
+import com.alibaba.fastjson.JSON;
+import lombok.extern.slf4j.Slf4j;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+import org.springframework.boot.test.context.SpringBootTest;
+import org.springframework.test.context.junit4.SpringRunner;
+
+import javax.annotation.Resource;
+import java.util.List;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 规则单元测试
+ * @create 2024-04-20 09:40
+ */
+@Slf4j
+@RunWith(SpringRunner.class)
+@SpringBootTest
+public class RuleTreeNodeDaoTest {
+
+    @Resource
+    private IRuleTreeNodeDao ruleTreeNodeDao;
+
+    @Test
+    public void test_queryRuleLocks() {
+        List<RuleTreeNode> ruleTreeNodes = ruleTreeNodeDao.queryRuleLocks(new String[]{"tree_lock_1", "tree_lock_2"});
+        log.info("测试结果:{}", JSON.toJSONString(ruleTreeNodes));
+    }
+
+}
diff --git a/big-market-app/src/test/java/cn/bugstack/test/trigger/RaffleActivityControllerTest.java b/big-market-app/src/test/java/cn/bugstack/test/trigger/RaffleActivityControllerTest.java
new file mode 100644
index 0000000..b233cee
--- /dev/null
+++ b/big-market-app/src/test/java/cn/bugstack/test/trigger/RaffleActivityControllerTest.java
@@ -0,0 +1,46 @@
+package cn.bugstack.test.trigger;
+
+import cn.bugstack.trigger.api.IRaffleActivityService;
+import cn.bugstack.trigger.api.dto.ActivityDrawRequestDTO;
+import cn.bugstack.trigger.api.dto.ActivityDrawResponseDTO;
+import cn.bugstack.types.model.Response;
+import com.alibaba.fastjson.JSON;
+import lombok.extern.slf4j.Slf4j;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+import org.springframework.boot.test.context.SpringBootTest;
+import org.springframework.test.context.junit4.SpringRunner;
+
+import javax.annotation.Resource;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 抽奖活动服务测试
+ * @create 2024-04-20 11:02
+ */
+@Slf4j
+@RunWith(SpringRunner.class)
+@SpringBootTest
+public class RaffleActivityControllerTest {
+
+    @Resource
+    private IRaffleActivityService raffleActivityService;
+
+    @Test
+    public void test_armory() {
+        Response<Boolean> response = raffleActivityService.armory(100301L);
+        log.info("测试结果：{}", JSON.toJSONString(response));
+    }
+
+    @Test
+    public void test_draw() {
+        ActivityDrawRequestDTO request = new ActivityDrawRequestDTO();
+        request.setActivityId(100301L);
+        request.setUserId("xiaofuge");
+        Response<ActivityDrawResponseDTO> response = raffleActivityService.draw(request);
+
+        log.info("请求参数：{}", JSON.toJSONString(request));
+        log.info("测试结果：{}", JSON.toJSONString(response));
+    }
+
+}
diff --git a/big-market-app/src/test/java/cn/bugstack/test/trigger/RaffleStrategyControllerTest.java b/big-market-app/src/test/java/cn/bugstack/test/trigger/RaffleStrategyControllerTest.java
new file mode 100644
index 0000000..ee787c4
--- /dev/null
+++ b/big-market-app/src/test/java/cn/bugstack/test/trigger/RaffleStrategyControllerTest.java
@@ -0,0 +1,41 @@
+package cn.bugstack.test.trigger;
+
+import cn.bugstack.trigger.api.IRaffleStrategyService;
+import cn.bugstack.trigger.api.dto.RaffleAwardListRequestDTO;
+import cn.bugstack.trigger.api.dto.RaffleAwardListResponseDTO;
+import cn.bugstack.types.model.Response;
+import com.alibaba.fastjson.JSON;
+import lombok.extern.slf4j.Slf4j;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+import org.springframework.boot.test.context.SpringBootTest;
+import org.springframework.test.context.junit4.SpringRunner;
+
+import javax.annotation.Resource;
+import java.util.List;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 营销抽奖服务测试
+ * @create 2024-04-20 10:41
+ */
+@Slf4j
+@RunWith(SpringRunner.class)
+@SpringBootTest
+public class RaffleStrategyControllerTest {
+
+    @Resource
+    private IRaffleStrategyService raffleStrategyService;
+
+    @Test
+    public void test_queryRaffleAwardList() {
+        RaffleAwardListRequestDTO request = new RaffleAwardListRequestDTO();
+        request.setUserId("xiaofuge");
+        request.setActivityId(100301L);
+        Response<List<RaffleAwardListResponseDTO>> response = raffleStrategyService.queryRaffleAwardList(request);
+
+        log.info("请求参数：{}", JSON.toJSONString(request));
+        log.info("测试结果：{}", JSON.toJSONString(response));
+    }
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/activity/model/entity/UserRaffleOrderEntity.java b/big-market-domain/src/main/java/cn/bugstack/domain/activity/model/entity/UserRaffleOrderEntity.java
index 6e53653..0cb5a2f 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/activity/model/entity/UserRaffleOrderEntity.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/activity/model/entity/UserRaffleOrderEntity.java
@@ -19,19 +19,21 @@ import java.util.Date;
 @NoArgsConstructor
 public class UserRaffleOrderEntity {
 
-    /** 活动ID */
+    /** 用户ID */
     private String userId;
-    /** 活动名称 */
+    /** 活动ID */
     private Long activityId;
-    /** 抽奖策略ID */
+    /** 活动名称 */
     private String activityName;
-    /** 订单ID */
+    /** 策略ID */
     private Long strategyId;
-    /** 下单时间 */
+    /** 订单ID */
     private String orderId;
-    /** 订单状态；create-创建、used-已使用、cancel-已作废 */
+    /** 下单时间 */
     private Date orderTime;
-    /** 创建时间 */
+    /** 活动状态；create-创建、used-已使用、cancel-已作废 */
     private UserRaffleOrderStateVO orderState;
+    /** 结束时间 */
+    private Date endDateTime;
 
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/activity/repository/IActivityRepository.java b/big-market-domain/src/main/java/cn/bugstack/domain/activity/repository/IActivityRepository.java
index 47ccc2e..2d9ff8e 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/activity/repository/IActivityRepository.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/activity/repository/IActivityRepository.java
@@ -49,4 +49,6 @@ public interface IActivityRepository {
 
     List<ActivitySkuEntity> queryActivitySkuListByActivityId(Long activityId);
 
+    Integer queryRaffleActivityAccountDayPartakeCount(Long activityId, String userId);
+
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/IRaffleActivityAccountQuotaService.java b/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/IRaffleActivityAccountQuotaService.java
index d080645..cab88ad 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/IRaffleActivityAccountQuotaService.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/IRaffleActivityAccountQuotaService.java
@@ -20,4 +20,13 @@ public interface IRaffleActivityAccountQuotaService {
      */
     String createOrder(SkuRechargeEntity skuRechargeEntity);
 
+    /**
+     * 查询活动账户 - 日，参与次数
+     *
+     * @param activityId 活动ID
+     * @param userId     用户ID
+     * @return 参与次数
+     */
+    Integer queryRaffleActivityAccountDayPartakeCount(Long activityId, String userId);
+
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/partake/AbstractRaffleActivityPartake.java b/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/partake/AbstractRaffleActivityPartake.java
index 8c9e9f1..0231a2c 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/partake/AbstractRaffleActivityPartake.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/partake/AbstractRaffleActivityPartake.java
@@ -68,6 +68,7 @@ public abstract class AbstractRaffleActivityPartake implements IRaffleActivityPa
         // 4. 构建订单
         UserRaffleOrderEntity userRaffleOrder = this.buildUserRaffleOrder(userId, activityId, currentDate);
 
+
         // 5. 填充抽奖单实体对象
         createPartakeOrderAggregate.setUserRaffleOrderEntity(userRaffleOrder);
 
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/partake/RaffleActivityPartakeService.java b/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/partake/RaffleActivityPartakeService.java
index 341c21f..b5d3fd6 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/partake/RaffleActivityPartakeService.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/partake/RaffleActivityPartakeService.java
@@ -99,6 +99,7 @@ public class RaffleActivityPartakeService extends AbstractRaffleActivityPartake{
         userRaffleOrder.setOrderId(RandomStringUtils.randomNumeric(12));
         userRaffleOrder.setOrderTime(currentDate);
         userRaffleOrder.setOrderState(UserRaffleOrderStateVO.create);
+        userRaffleOrder.setEndDateTime(activityEntity.getEndDateTime());
         return userRaffleOrder;
     }
 
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/quota/RaffleActivityAccountQuotaService.java b/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/quota/RaffleActivityAccountQuotaService.java
index 555dfe3..c6b7cc6 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/quota/RaffleActivityAccountQuotaService.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/activity/service/quota/RaffleActivityAccountQuotaService.java
@@ -78,4 +78,9 @@ public class RaffleActivityAccountQuotaService extends AbstractRaffleActivityAcc
         activityRepository.clearActivitySkuStock(sku);
     }
 
+    @Override
+    public Integer queryRaffleActivityAccountDayPartakeCount(Long activityId, String userId) {
+        return activityRepository.queryRaffleActivityAccountDayPartakeCount(activityId, userId);
+    }
+
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/model/aggregate/package-info.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/model/aggregate/package-info.java
new file mode 100644
index 0000000..3b714ac
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/model/aggregate/package-info.java
@@ -0,0 +1,6 @@
+/**
+ * @description 当有需要写库的时候再创建聚合
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @create 2024-04-20 09:08
+ */
+package cn.bugstack.domain.strategy.model.aggregate;
\ No newline at end of file
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/model/entity/RaffleFactorEntity.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/model/entity/RaffleFactorEntity.java
index 28cdaaa..88f8ba8 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/model/entity/RaffleFactorEntity.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/model/entity/RaffleFactorEntity.java
@@ -5,6 +5,8 @@ import lombok.Builder;
 import lombok.Data;
 import lombok.NoArgsConstructor;
 
+import java.util.Date;
+
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
  * @description 抽奖因子实体
@@ -20,5 +22,7 @@ public class RaffleFactorEntity {
     private String userId;
     /** 策略ID */
     private Long strategyId;
+    /** 结束时间 */
+    private Date endDateTime;
 
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/model/entity/StrategyAwardEntity.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/model/entity/StrategyAwardEntity.java
index c259ee3..0f5edf7 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/model/entity/StrategyAwardEntity.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/model/entity/StrategyAwardEntity.java
@@ -34,5 +34,7 @@ public class StrategyAwardEntity {
     private BigDecimal awardRate;
     /** 排序 */
     private Integer sort;
+    /** 规则模型，rule配置的模型同步到此表，便于使用 */
+    private String ruleModels;
 
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/repository/IStrategyRepository.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/repository/IStrategyRepository.java
index 7f05ea3..e55cf6c 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/repository/IStrategyRepository.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/repository/IStrategyRepository.java
@@ -7,6 +7,7 @@ import cn.bugstack.domain.strategy.model.valobj.RuleTreeVO;
 import cn.bugstack.domain.strategy.model.valobj.StrategyAwardRuleModelVO;
 import cn.bugstack.domain.strategy.model.valobj.StrategyAwardStockKeyVO;
 
+import java.util.Date;
 import java.util.List;
 import java.util.Map;
 
@@ -61,6 +62,15 @@ public interface IStrategyRepository {
      */
     Boolean subtractionAwardStock(String cacheKey);
 
+    /**
+     * 缓存key，decr 方式扣减库存
+     *
+     * @param cacheKey 缓存Key
+     * @param endDateTime 活动结束时间
+     * @return 扣减结果
+     */
+    Boolean subtractionAwardStock(String cacheKey, Date endDateTime);
+
     /**
      * 写入奖品库存消费队列
      *
@@ -107,4 +117,12 @@ public interface IStrategyRepository {
      */
     Integer queryTodayUserRaffleCount(String userId, Long strategyId);
 
+    /**
+     * 根据规则树ID集合查询奖品中加锁数量的配置「部分奖品需要抽奖N次解锁」
+     *
+     * @param treeIds 规则树ID值
+     * @return key 规则树，value rule_lock 加锁值
+     */
+    Map<String, Integer> queryAwardRuleLockCount(String[] treeIds);
+
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/AbstractRaffleStrategy.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/AbstractRaffleStrategy.java
index 5291f17..5dff8b3 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/AbstractRaffleStrategy.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/AbstractRaffleStrategy.java
@@ -12,6 +12,8 @@ import cn.bugstack.types.exception.AppException;
 import lombok.extern.slf4j.Slf4j;
 import org.apache.commons.lang3.StringUtils;
 
+import java.util.Date;
+
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
  * @description 抽奖策略抽象类，定义抽奖的标准流程
@@ -55,7 +57,7 @@ public abstract class AbstractRaffleStrategy implements IRaffleStrategy {
         }
 
         // 3. 规则树抽奖过滤【奖品ID，会根据抽奖次数判断、库存判断、兜底兜里返回最终的可获得奖品信息】
-        DefaultTreeFactory.StrategyAwardVO treeStrategyAwardVO = raffleLogicTree(userId, strategyId, chainStrategyAwardVO.getAwardId());
+        DefaultTreeFactory.StrategyAwardVO treeStrategyAwardVO = raffleLogicTree(userId, strategyId, chainStrategyAwardVO.getAwardId(), raffleFactorEntity.getEndDateTime());
         log.info("抽奖策略计算-规则树 {} {} {} {}", userId, strategyId, treeStrategyAwardVO.getAwardId(), treeStrategyAwardVO.getAwardRuleValue());
 
         // 4. 返回抽奖结果
@@ -91,4 +93,15 @@ public abstract class AbstractRaffleStrategy implements IRaffleStrategy {
      */
     public abstract DefaultTreeFactory.StrategyAwardVO raffleLogicTree(String userId, Long strategyId, Integer awardId);
 
+    /**
+     * 抽奖结果过滤，决策树抽象方法
+     *
+     * @param userId      用户ID
+     * @param strategyId  策略ID
+     * @param awardId     奖品ID
+     * @param endDateTime 活动结束时间 - 用于设定缓存有效期
+     * @return 过滤结果【奖品ID，会根据抽奖次数判断、库存判断、兜底兜里返回最终的可获得奖品信息】
+     */
+    public abstract DefaultTreeFactory.StrategyAwardVO raffleLogicTree(String userId, Long strategyId, Integer awardId, Date endDateTime);
+
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/IRaffleAward.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/IRaffleAward.java
index 2373e41..2e0d6bb 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/IRaffleAward.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/IRaffleAward.java
@@ -19,4 +19,12 @@ public interface IRaffleAward {
      */
     List<StrategyAwardEntity> queryRaffleStrategyAwardList(Long strategyId);
 
+    /**
+     * 根据策略ID查询抽奖奖品列表配置
+     *
+     * @param activityId 策略ID
+     * @return 奖品列表
+     */
+    List<StrategyAwardEntity> queryRaffleStrategyAwardListByActivityId(Long activityId);
+
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/IRaffleRule.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/IRaffleRule.java
new file mode 100644
index 0000000..b678426
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/IRaffleRule.java
@@ -0,0 +1,20 @@
+package cn.bugstack.domain.strategy.service;
+
+import java.util.Map;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 抽奖规则接口；提供对规则的业务功能查询
+ * @create 2024-04-20 09:17
+ */
+public interface IRaffleRule {
+
+    /**
+     * 根据规则树ID集合查询奖品中加锁数量的配置「部分奖品需要抽奖N次解锁」
+     *
+     * @param treeIds 规则树ID值
+     * @return key 规则树，value rule_lock 加锁值
+     */
+    Map<String, Integer> queryAwardRuleLockCount(String[] treeIds);
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/armory/IStrategyDispatch.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/armory/IStrategyDispatch.java
index 3ffab53..eb818f2 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/armory/IStrategyDispatch.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/armory/IStrategyDispatch.java
@@ -1,5 +1,7 @@
 package cn.bugstack.domain.strategy.service.armory;
 
+import java.util.Date;
+
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
  * @description 策略抽奖调度
@@ -34,10 +36,11 @@ public interface IStrategyDispatch {
     /**
      * 根据策略ID和奖品ID，扣减奖品缓存库存
      *
-     * @param strategyId 策略ID
-     * @param awardId    奖品ID
+     * @param strategyId  策略ID
+     * @param awardId     奖品ID
+     * @param endDateTime 活动结束时间
      * @return 扣减结果
      */
-    Boolean subtractionAwardStock(Long strategyId, Integer awardId);
+    Boolean subtractionAwardStock(Long strategyId, Integer awardId, Date endDateTime);
 
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/armory/StrategyArmoryDispatch.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/armory/StrategyArmoryDispatch.java
index 83f6cf9..404198d 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/armory/StrategyArmoryDispatch.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/armory/StrategyArmoryDispatch.java
@@ -117,7 +117,7 @@ public class StrategyArmoryDispatch implements IStrategyArmory, IStrategyDispatc
      * 转换计算，只根据小数位来计算。如【0.01返回100】、【0.009返回1000】、【0.0018返回10000】
      */
     private double convert(double min) {
-        if(0 == min) return 1D;
+        if (0 == min) return 1D;
 
         double current = min;
         double max = 1;
@@ -163,9 +163,9 @@ public class StrategyArmoryDispatch implements IStrategyArmory, IStrategyDispatc
     }
 
     @Override
-    public Boolean subtractionAwardStock(Long strategyId, Integer awardId) {
+    public Boolean subtractionAwardStock(Long strategyId, Integer awardId, Date endDateTime) {
         String cacheKey = Constants.RedisKey.STRATEGY_AWARD_COUNT_KEY + strategyId + Constants.UNDERLINE + awardId;
-        return repository.subtractionAwardStock(cacheKey);
+        return repository.subtractionAwardStock(cacheKey, endDateTime);
     }
 
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/raffle/DefaultRaffleStrategy.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/raffle/DefaultRaffleStrategy.java
index 71ff290..4f9cc82 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/raffle/DefaultRaffleStrategy.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/raffle/DefaultRaffleStrategy.java
@@ -7,6 +7,7 @@ import cn.bugstack.domain.strategy.model.valobj.StrategyAwardStockKeyVO;
 import cn.bugstack.domain.strategy.repository.IStrategyRepository;
 import cn.bugstack.domain.strategy.service.AbstractRaffleStrategy;
 import cn.bugstack.domain.strategy.service.IRaffleAward;
+import cn.bugstack.domain.strategy.service.IRaffleRule;
 import cn.bugstack.domain.strategy.service.IRaffleStock;
 import cn.bugstack.domain.strategy.service.armory.IStrategyDispatch;
 import cn.bugstack.domain.strategy.service.rule.chain.ILogicChain;
@@ -16,7 +17,10 @@ import cn.bugstack.domain.strategy.service.rule.tree.factory.engine.IDecisionTre
 import lombok.extern.slf4j.Slf4j;
 import org.springframework.stereotype.Service;
 
+import java.util.Date;
+import java.util.HashMap;
 import java.util.List;
+import java.util.Map;
 
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
@@ -25,7 +29,7 @@ import java.util.List;
  */
 @Slf4j
 @Service
-public class DefaultRaffleStrategy extends AbstractRaffleStrategy implements IRaffleStock, IRaffleAward {
+public class DefaultRaffleStrategy extends AbstractRaffleStrategy implements IRaffleStock, IRaffleAward, IRaffleRule {
 
     public DefaultRaffleStrategy(IStrategyRepository repository, IStrategyDispatch strategyDispatch, DefaultChainFactory defaultChainFactory, DefaultTreeFactory defaultTreeFactory) {
         super(repository, strategyDispatch, defaultChainFactory, defaultTreeFactory);
@@ -39,6 +43,11 @@ public class DefaultRaffleStrategy extends AbstractRaffleStrategy implements IRa
 
     @Override
     public DefaultTreeFactory.StrategyAwardVO raffleLogicTree(String userId, Long strategyId, Integer awardId) {
+        return raffleLogicTree(userId, strategyId, awardId, null);
+    }
+
+    @Override
+    public DefaultTreeFactory.StrategyAwardVO raffleLogicTree(String userId, Long strategyId, Integer awardId, Date endDateTime) {
         StrategyAwardRuleModelVO strategyAwardRuleModelVO = repository.queryStrategyAwardRuleModelVO(strategyId, awardId);
         if (null == strategyAwardRuleModelVO) {
             return DefaultTreeFactory.StrategyAwardVO.builder().awardId(awardId).build();
@@ -48,7 +57,7 @@ public class DefaultRaffleStrategy extends AbstractRaffleStrategy implements IRa
             throw new RuntimeException("存在抽奖策略配置的规则模型 Key，未在库表 rule_tree、rule_tree_node、rule_tree_line 配置对应的规则树信息 " + strategyAwardRuleModelVO.getRuleModels());
         }
         IDecisionTreeEngine treeEngine = defaultTreeFactory.openLogicTree(ruleTreeVO);
-        return treeEngine.process(userId, strategyId, awardId);
+        return treeEngine.process(userId, strategyId, awardId, endDateTime);
     }
 
     @Override
@@ -66,4 +75,15 @@ public class DefaultRaffleStrategy extends AbstractRaffleStrategy implements IRa
         return repository.queryStrategyAwardList(strategyId);
     }
 
+    @Override
+    public List<StrategyAwardEntity> queryRaffleStrategyAwardListByActivityId(Long activityId) {
+        Long strategyId = repository.queryStrategyIdByActivityId(activityId);
+        return queryRaffleStrategyAwardList(strategyId);
+    }
+
+    @Override
+    public Map<String, Integer> queryAwardRuleLockCount(String[] treeIds) {
+        return repository.queryAwardRuleLockCount(treeIds);
+    }
+
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/ILogicTreeNode.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/ILogicTreeNode.java
index 75c0efe..9878b51 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/ILogicTreeNode.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/ILogicTreeNode.java
@@ -2,6 +2,8 @@ package cn.bugstack.domain.strategy.service.rule.tree;
 
 import cn.bugstack.domain.strategy.service.rule.tree.factory.DefaultTreeFactory;
 
+import java.util.Date;
+
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
  * @description 规则树接口
@@ -9,6 +11,6 @@ import cn.bugstack.domain.strategy.service.rule.tree.factory.DefaultTreeFactory;
  */
 public interface ILogicTreeNode {
 
-    DefaultTreeFactory.TreeActionEntity logic(String userId, Long strategyId, Integer awardId, String ruleValue);
+    DefaultTreeFactory.TreeActionEntity logic(String userId, Long strategyId, Integer awardId, String ruleValue, Date endDateTime);
 
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/factory/engine/IDecisionTreeEngine.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/factory/engine/IDecisionTreeEngine.java
index 9598b24..050c400 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/factory/engine/IDecisionTreeEngine.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/factory/engine/IDecisionTreeEngine.java
@@ -2,6 +2,8 @@ package cn.bugstack.domain.strategy.service.rule.tree.factory.engine;
 
 import cn.bugstack.domain.strategy.service.rule.tree.factory.DefaultTreeFactory;
 
+import java.util.Date;
+
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
  * @description 规则树组合接口
@@ -9,6 +11,6 @@ import cn.bugstack.domain.strategy.service.rule.tree.factory.DefaultTreeFactory;
  */
 public interface IDecisionTreeEngine {
 
-    DefaultTreeFactory.StrategyAwardVO process(String userId, Long strategyId, Integer awardId);
+    DefaultTreeFactory.StrategyAwardVO process(String userId, Long strategyId, Integer awardId, Date endDateTime);
 
 }
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/factory/engine/impl/DecisionTreeEngine.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/factory/engine/impl/DecisionTreeEngine.java
index a7bd234..af3f6a1 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/factory/engine/impl/DecisionTreeEngine.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/factory/engine/impl/DecisionTreeEngine.java
@@ -6,6 +6,7 @@ import cn.bugstack.domain.strategy.service.rule.tree.factory.DefaultTreeFactory;
 import cn.bugstack.domain.strategy.service.rule.tree.factory.engine.IDecisionTreeEngine;
 import lombok.extern.slf4j.Slf4j;
 
+import java.util.Date;
 import java.util.List;
 import java.util.Map;
 
@@ -27,7 +28,7 @@ public class DecisionTreeEngine implements IDecisionTreeEngine {
     }
 
     @Override
-    public DefaultTreeFactory.StrategyAwardVO process(String userId, Long strategyId, Integer awardId) {
+    public DefaultTreeFactory.StrategyAwardVO process(String userId, Long strategyId, Integer awardId, Date endDateTime) {
         DefaultTreeFactory.StrategyAwardVO strategyAwardData = null;
 
         // 获取基础信息
@@ -42,7 +43,7 @@ public class DecisionTreeEngine implements IDecisionTreeEngine {
             String ruleValue = ruleTreeNode.getRuleValue();
 
             // 决策节点计算
-            DefaultTreeFactory.TreeActionEntity logicEntity = logicTreeNode.logic(userId, strategyId, awardId, ruleValue);
+            DefaultTreeFactory.TreeActionEntity logicEntity = logicTreeNode.logic(userId, strategyId, awardId, ruleValue, endDateTime);
             RuleLogicCheckTypeVO ruleLogicCheckTypeVO = logicEntity.getRuleLogicCheckType();
             strategyAwardData = logicEntity.getStrategyAwardVO();
             log.info("决策树引擎【{}】treeId:{} node:{} code:{}", ruleTreeVO.getTreeName(), ruleTreeVO.getTreeId(), nextNode, ruleLogicCheckTypeVO.getCode());
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleLockLogicTreeNode.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleLockLogicTreeNode.java
index e26ac6d..05fa553 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleLockLogicTreeNode.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleLockLogicTreeNode.java
@@ -8,6 +8,7 @@ import lombok.extern.slf4j.Slf4j;
 import org.springframework.stereotype.Component;
 
 import javax.annotation.Resource;
+import java.util.Date;
 
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
@@ -22,7 +23,7 @@ public class RuleLockLogicTreeNode implements ILogicTreeNode {
     private IStrategyRepository repository;
 
     @Override
-    public DefaultTreeFactory.TreeActionEntity logic(String userId, Long strategyId, Integer awardId, String ruleValue) {
+    public DefaultTreeFactory.TreeActionEntity logic(String userId, Long strategyId, Integer awardId, String ruleValue, Date endDateTime) {
         log.info("规则过滤-次数锁 userId:{} strategyId:{} awardId:{}", userId, strategyId, awardId);
 
         long raffleCount = 0L;
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleLuckAwardLogicTreeNode.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleLuckAwardLogicTreeNode.java
index d538b76..6df8808 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleLuckAwardLogicTreeNode.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleLuckAwardLogicTreeNode.java
@@ -7,6 +7,8 @@ import cn.bugstack.types.common.Constants;
 import lombok.extern.slf4j.Slf4j;
 import org.springframework.stereotype.Component;
 
+import java.util.Date;
+
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
  * @description 兜底奖励节点
@@ -17,7 +19,7 @@ import org.springframework.stereotype.Component;
 public class RuleLuckAwardLogicTreeNode implements ILogicTreeNode {
 
     @Override
-    public DefaultTreeFactory.TreeActionEntity logic(String userId, Long strategyId, Integer awardId, String ruleValue) {
+    public DefaultTreeFactory.TreeActionEntity logic(String userId, Long strategyId, Integer awardId, String ruleValue, Date endDateTime) {
         log.info("规则过滤-兜底奖品 userId:{} strategyId:{} awardId:{} ruleValue:{}", userId, strategyId, awardId, ruleValue);
         String[] split = ruleValue.split(Constants.COLON);
         if (split.length == 0) {
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleStockLogicTreeNode.java b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleStockLogicTreeNode.java
index 9822443..08e8260 100644
--- a/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleStockLogicTreeNode.java
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/strategy/service/rule/tree/impl/RuleStockLogicTreeNode.java
@@ -6,10 +6,12 @@ import cn.bugstack.domain.strategy.repository.IStrategyRepository;
 import cn.bugstack.domain.strategy.service.armory.IStrategyDispatch;
 import cn.bugstack.domain.strategy.service.rule.tree.ILogicTreeNode;
 import cn.bugstack.domain.strategy.service.rule.tree.factory.DefaultTreeFactory;
+import lombok.Data;
 import lombok.extern.slf4j.Slf4j;
 import org.springframework.stereotype.Component;
 
 import javax.annotation.Resource;
+import java.util.Date;
 
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
@@ -26,10 +28,10 @@ public class RuleStockLogicTreeNode implements ILogicTreeNode {
     private IStrategyRepository strategyRepository;
 
     @Override
-    public DefaultTreeFactory.TreeActionEntity logic(String userId, Long strategyId, Integer awardId, String ruleValue) {
+    public DefaultTreeFactory.TreeActionEntity logic(String userId, Long strategyId, Integer awardId, String ruleValue, Date endDateTime) {
         log.info("规则过滤-库存扣减 userId:{} strategyId:{} awardId:{}", userId, strategyId, awardId);
         // 扣减库存
-        Boolean status = strategyDispatch.subtractionAwardStock(strategyId, awardId);
+        Boolean status = strategyDispatch.subtractionAwardStock(strategyId, awardId, endDateTime);
         // true；库存扣减成功，TAKE_OVER 规则节点接管，返回奖品ID，奖品规则配置
         if (status) {
             log.info("规则过滤-库存扣减-成功 userId:{} strategyId:{} awardId:{}", userId, strategyId, awardId);
diff --git a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRaffleActivityAccountDayDao.java b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRaffleActivityAccountDayDao.java
index be4ef56..d8660c3 100644
--- a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRaffleActivityAccountDayDao.java
+++ b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRaffleActivityAccountDayDao.java
@@ -19,4 +19,7 @@ public interface IRaffleActivityAccountDayDao {
 
     void insertActivityAccountDay(RaffleActivityAccountDay raffleActivityAccountDay);
 
+    @DBRouter
+    Integer queryRaffleActivityAccountDayPartakeCount(RaffleActivityAccountDay raffleActivityAccountDay);
+
 }
diff --git a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRaffleActivityDao.java b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRaffleActivityDao.java
index b052d68..18c4751 100644
--- a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRaffleActivityDao.java
+++ b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRaffleActivityDao.java
@@ -4,6 +4,8 @@ import cn.bugstack.infrastructure.persistent.po.RaffleActivity;
 import cn.bugstack.infrastructure.persistent.po.RaffleActivityAccount;
 import org.apache.ibatis.annotations.Mapper;
 
+import java.util.Date;
+
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
  * @description 抽奖活动表Dao
diff --git a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRuleTreeNodeDao.java b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRuleTreeNodeDao.java
index 1939f8c..68b8d3a 100644
--- a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRuleTreeNodeDao.java
+++ b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IRuleTreeNodeDao.java
@@ -15,4 +15,6 @@ public interface IRuleTreeNodeDao {
 
     List<RuleTreeNode> queryRuleTreeNodeListByTreeId(String treeId);
 
+    List<RuleTreeNode> queryRuleLocks(String[] treeIds);
+
 }
diff --git a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/ActivityRepository.java b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/ActivityRepository.java
index 1220067..c9bc967 100644
--- a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/ActivityRepository.java
+++ b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/ActivityRepository.java
@@ -444,7 +444,7 @@ public class ActivityRepository implements IActivityRepository {
     public List<ActivitySkuEntity> queryActivitySkuListByActivityId(Long activityId) {
         List<RaffleActivitySku> raffleActivitySkus = raffleActivitySkuDao.queryActivitySkuListByActivityId(activityId);
         List<ActivitySkuEntity> activitySkuEntities = new ArrayList<>(raffleActivitySkus.size());
-        for (RaffleActivitySku raffleActivitySku:raffleActivitySkus){
+        for (RaffleActivitySku raffleActivitySku : raffleActivitySkus) {
             ActivitySkuEntity activitySkuEntity = new ActivitySkuEntity();
             activitySkuEntity.setSku(raffleActivitySku.getSku());
             activitySkuEntity.setActivityCountId(raffleActivitySku.getActivityCountId());
@@ -455,4 +455,15 @@ public class ActivityRepository implements IActivityRepository {
         return activitySkuEntities;
     }
 
+    @Override
+    public Integer queryRaffleActivityAccountDayPartakeCount(Long activityId, String userId) {
+        RaffleActivityAccountDay raffleActivityAccountDay = new RaffleActivityAccountDay();
+        raffleActivityAccountDay.setActivityId(activityId);
+        raffleActivityAccountDay.setUserId(userId);
+        raffleActivityAccountDay.setDay(raffleActivityAccountDay.currentDay());
+        Integer dayPartakeCount = raffleActivityAccountDayDao.queryRaffleActivityAccountDayPartakeCount(raffleActivityAccountDay);
+        // 当日未参与抽奖则为0次
+        return null == dayPartakeCount ? 0 : dayPartakeCount;
+    }
+
 }
diff --git a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/StrategyRepository.java b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/StrategyRepository.java
index 5c6f2d6..6a9c116 100644
--- a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/StrategyRepository.java
+++ b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/StrategyRepository.java
@@ -1,5 +1,7 @@
 package cn.bugstack.infrastructure.persistent.repository;
 
+import cn.bugstack.domain.activity.model.entity.ActivityEntity;
+import cn.bugstack.domain.activity.model.valobj.ActivityStateVO;
 import cn.bugstack.domain.strategy.model.entity.StrategyAwardEntity;
 import cn.bugstack.domain.strategy.model.entity.StrategyEntity;
 import cn.bugstack.domain.strategy.model.entity.StrategyRuleEntity;
@@ -11,15 +13,13 @@ import cn.bugstack.infrastructure.persistent.redis.IRedisService;
 import cn.bugstack.types.common.Constants;
 import cn.bugstack.types.exception.AppException;
 import lombok.extern.slf4j.Slf4j;
+import org.apache.commons.lang3.StringUtils;
 import org.redisson.api.RBlockingQueue;
 import org.redisson.api.RDelayedQueue;
 import org.springframework.stereotype.Repository;
 
 import javax.annotation.Resource;
-import java.util.ArrayList;
-import java.util.HashMap;
-import java.util.List;
-import java.util.Map;
+import java.util.*;
 import java.util.concurrent.TimeUnit;
 
 import static cn.bugstack.types.enums.ResponseCode.UN_ASSEMBLED_STRATEGY_ARMORY;
@@ -71,6 +71,7 @@ public class StrategyRepository implements IStrategyRepository {
                     .awardCountSurplus(strategyAward.getAwardCountSurplus())
                     .awardRate(strategyAward.getAwardRate())
                     .sort(strategyAward.getSort())
+                    .ruleModels(strategyAward.getRuleModels())
                     .build();
             strategyAwardEntities.add(strategyAwardEntity);
         }
@@ -232,6 +233,11 @@ public class StrategyRepository implements IStrategyRepository {
 
     @Override
     public Boolean subtractionAwardStock(String cacheKey) {
+        return subtractionAwardStock(cacheKey, null);
+    }
+
+    @Override
+    public Boolean subtractionAwardStock(String cacheKey, Date endDateTime) {
         long surplus = redisService.decr(cacheKey);
         if (surplus < 0) {
             // 库存小于0，恢复为0个
@@ -241,7 +247,13 @@ public class StrategyRepository implements IStrategyRepository {
         // 1. 按照cacheKey decr 后的值，如 99、98、97 和 key 组成为库存锁的key进行使用。
         // 2. 加锁为了兜底，如果后续有恢复库存，手动处理等，也不会超卖。因为所有的可用库存key，都被加锁了。
         String lockKey = cacheKey + Constants.UNDERLINE + surplus;
-        Boolean lock = redisService.setNx(lockKey);
+        Boolean lock = false;
+        if (null != endDateTime) {
+            long expireMillis = endDateTime.getTime() - System.currentTimeMillis() + TimeUnit.DAYS.toMillis(1);
+            lock = redisService.setNx(lockKey, expireMillis, TimeUnit.MILLISECONDS);
+        } else {
+            lock = redisService.setNx(lockKey);
+        }
         if (!lock) {
             log.info("策略奖品库存加锁失败 {}", lockKey);
         }
@@ -319,4 +331,17 @@ public class StrategyRepository implements IStrategyRepository {
         return raffleActivityAccountDay.getDayCount() - raffleActivityAccountDay.getDayCountSurplus();
     }
 
+    @Override
+    public Map<String, Integer> queryAwardRuleLockCount(String[] treeIds) {
+        if (null == treeIds || treeIds.length == 0) return new HashMap<>();
+        List<RuleTreeNode> ruleTreeNodes = ruleTreeNodeDao.queryRuleLocks(treeIds);
+        Map<String, Integer> resultMap = new HashMap<>();
+        for (RuleTreeNode node : ruleTreeNodes) {
+            String treeId = node.getTreeId();
+            Integer ruleValue = Integer.valueOf(node.getRuleValue());
+            resultMap.put(treeId, ruleValue);
+        }
+        return resultMap;
+    }
+
 }
diff --git a/big-market-trigger/src/main/java/cn/bugstack/trigger/http/RaffleActivityController.java b/big-market-trigger/src/main/java/cn/bugstack/trigger/http/RaffleActivityController.java
index b006bcd..5a3a03d 100644
--- a/big-market-trigger/src/main/java/cn/bugstack/trigger/http/RaffleActivityController.java
+++ b/big-market-trigger/src/main/java/cn/bugstack/trigger/http/RaffleActivityController.java
@@ -53,9 +53,9 @@ public class RaffleActivityController implements IRaffleActivityService {
      * <p>
      * 接口：<a href="http://localhost:8091/api/v1/raffle/activity/armory">/api/v1/raffle/activity/armory</a>
      * 入参：{"activityId":100001,"userId":"xiaofuge"}
-     *
+     * <p>
      * curl --request GET \
-     *   --url 'http://localhost:8091/api/v1/raffle/activity/armory?activityId=100301'
+     * --url 'http://localhost:8091/api/v1/raffle/activity/armory?activityId=100301'
      */
     @RequestMapping(value = "armory", method = RequestMethod.GET)
     @Override
@@ -90,13 +90,13 @@ public class RaffleActivityController implements IRaffleActivityService {
      * <p>
      * 接口：<a href="http://localhost:8091/api/v1/raffle/activity/draw">/api/v1/raffle/activity/draw</a>
      * 入参：{"activityId":100001,"userId":"xiaofuge"}
-     *
+     * <p>
      * curl --request POST \
-     *   --url http://localhost:8091/api/v1/raffle/activity/draw \
-     *   --header 'content-type: application/json' \
-     *   --data '{
-     *     "userId":"xiaofuge",
-     *     "activityId": 100301
+     * --url http://localhost:8091/api/v1/raffle/activity/draw \
+     * --header 'content-type: application/json' \
+     * --data '{
+     * "userId":"xiaofuge",
+     * "activityId": 100301
      * }'
      */
     @RequestMapping(value = "draw", method = RequestMethod.POST)
@@ -115,6 +115,7 @@ public class RaffleActivityController implements IRaffleActivityService {
             RaffleAwardEntity raffleAwardEntity = raffleStrategy.performRaffle(RaffleFactorEntity.builder()
                     .userId(orderEntity.getUserId())
                     .strategyId(orderEntity.getStrategyId())
+                    .endDateTime(orderEntity.getEndDateTime())
                     .build());
             // 4. 存放结果 - 写入中奖记录
             UserAwardRecordEntity userAwardRecord = UserAwardRecordEntity.builder()
diff --git a/big-market-trigger/src/main/java/cn/bugstack/trigger/http/RaffleStrategyController.java b/big-market-trigger/src/main/java/cn/bugstack/trigger/http/RaffleStrategyController.java
index 6b71850..ac7b0df 100644
--- a/big-market-trigger/src/main/java/cn/bugstack/trigger/http/RaffleStrategyController.java
+++ b/big-market-trigger/src/main/java/cn/bugstack/trigger/http/RaffleStrategyController.java
@@ -1,9 +1,11 @@
 package cn.bugstack.trigger.http;
 
+import cn.bugstack.domain.activity.service.IRaffleActivityAccountQuotaService;
 import cn.bugstack.domain.strategy.model.entity.RaffleAwardEntity;
 import cn.bugstack.domain.strategy.model.entity.RaffleFactorEntity;
 import cn.bugstack.domain.strategy.model.entity.StrategyAwardEntity;
 import cn.bugstack.domain.strategy.service.IRaffleAward;
+import cn.bugstack.domain.strategy.service.IRaffleRule;
 import cn.bugstack.domain.strategy.service.IRaffleStrategy;
 import cn.bugstack.domain.strategy.service.armory.IStrategyArmory;
 import cn.bugstack.trigger.api.IRaffleStrategyService;
@@ -16,11 +18,13 @@ import cn.bugstack.types.exception.AppException;
 import cn.bugstack.types.model.Response;
 import com.alibaba.fastjson.JSON;
 import lombok.extern.slf4j.Slf4j;
+import org.apache.commons.lang3.StringUtils;
 import org.springframework.web.bind.annotation.*;
 
 import javax.annotation.Resource;
 import java.util.ArrayList;
 import java.util.List;
+import java.util.Map;
 
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
@@ -36,9 +40,13 @@ public class RaffleStrategyController implements IRaffleStrategyService {
     @Resource
     private IRaffleAward raffleAward;
     @Resource
+    private IRaffleRule raffleRule;
+    @Resource
     private IRaffleStrategy raffleStrategy;
     @Resource
     private IStrategyArmory strategyArmory;
+    @Resource
+    private IRaffleActivityAccountQuotaService raffleActivityAccountQuotaService;
 
     /**
      * 策略装配，将策略信息装配到缓存中
@@ -74,23 +82,41 @@ public class RaffleStrategyController implements IRaffleStrategyService {
      * <a href="http://localhost:8091/api/v1/raffle/strategy/query_raffle_award_list">/api/v1/raffle/query_raffle_award_list</a>
      * 请求参数 raw json
      *
-     * @param requestDTO {"strategyId":1000001}
+     * @param request {"activityId":100301,"userId":"xiaofuge"}
      * @return 奖品列表
      */
     @RequestMapping(value = "query_raffle_award_list", method = RequestMethod.POST)
     @Override
-    public Response<List<RaffleAwardListResponseDTO>> queryRaffleAwardList(@RequestBody RaffleAwardListRequestDTO requestDTO) {
+    public Response<List<RaffleAwardListResponseDTO>> queryRaffleAwardList(@RequestBody RaffleAwardListRequestDTO request) {
         try {
-            log.info("查询抽奖奖品列表配开始 strategyId：{}", requestDTO.getStrategyId());
-            // 查询奖品配置
-            List<StrategyAwardEntity> strategyAwardEntities = raffleAward.queryRaffleStrategyAwardList(requestDTO.getStrategyId());
+            log.info("查询抽奖奖品列表配开始 userId:{} activityId：{}", request.getUserId(), request.getActivityId());
+            // 1. 参数校验
+            if (StringUtils.isBlank(request.getUserId()) || null == request.getActivityId()) {
+                throw new AppException(ResponseCode.ILLEGAL_PARAMETER.getCode(), ResponseCode.ILLEGAL_PARAMETER.getInfo());
+            }
+            // 2. 查询奖品配置
+            List<StrategyAwardEntity> strategyAwardEntities = raffleAward.queryRaffleStrategyAwardListByActivityId(request.getActivityId());
+            // 3. 获取规则配置
+            String[] treeIds = strategyAwardEntities.stream()
+                    .map(StrategyAwardEntity::getRuleModels)
+                    .filter(ruleModel -> ruleModel != null && !ruleModel.isEmpty())
+                    .toArray(String[]::new);
+            // 4. 查询规则配置 - 获取奖品的解锁限制，抽奖N次后解锁
+            Map<String, Integer> ruleLockCountMap = raffleRule.queryAwardRuleLockCount(treeIds);
+            // 5. 查询抽奖次数 - 用户已经参与的抽奖次数
+            Integer dayPartakeCount = raffleActivityAccountQuotaService.queryRaffleActivityAccountDayPartakeCount(request.getActivityId(), request.getUserId());
+            // 6. 遍历填充数据
             List<RaffleAwardListResponseDTO> raffleAwardListResponseDTOS = new ArrayList<>(strategyAwardEntities.size());
             for (StrategyAwardEntity strategyAward : strategyAwardEntities) {
+                Integer awardRuleLockCount = ruleLockCountMap.get(strategyAward.getRuleModels());
                 raffleAwardListResponseDTOS.add(RaffleAwardListResponseDTO.builder()
                         .awardId(strategyAward.getAwardId())
                         .awardTitle(strategyAward.getAwardTitle())
                         .awardSubtitle(strategyAward.getAwardSubtitle())
                         .sort(strategyAward.getSort())
+                        .awardRuleLockCount(awardRuleLockCount)
+                        .isAwardUnlock(null == awardRuleLockCount || dayPartakeCount >= awardRuleLockCount)
+                        .waitUnLockCount(null == awardRuleLockCount || awardRuleLockCount <= dayPartakeCount ? 0 : awardRuleLockCount - dayPartakeCount)
                         .build());
             }
             Response<List<RaffleAwardListResponseDTO>> response = Response.<List<RaffleAwardListResponseDTO>>builder()
@@ -98,11 +124,11 @@ public class RaffleStrategyController implements IRaffleStrategyService {
                     .info(ResponseCode.SUCCESS.getInfo())
                     .data(raffleAwardListResponseDTOS)
                     .build();
-            log.info("查询抽奖奖品列表配置完成 strategyId：{} response: {}", requestDTO.getStrategyId(), JSON.toJSONString(response));
+            log.info("查询抽奖奖品列表配置完成 userId:{} activityId：{} response: {}", request.getUserId(), request.getActivityId(), JSON.toJSONString(response));
             // 返回结果
             return response;
         } catch (Exception e) {
-            log.error("查询抽奖奖品列表配置失败 strategyId：{}", requestDTO.getStrategyId(), e);
+            log.error("查询抽奖奖品列表配置失败 userId:{} activityId：{}", request.getUserId(), request.getActivityId(), e);
             return Response.<List<RaffleAwardListResponseDTO>>builder()
                     .code(ResponseCode.UN_ERROR.getCode())
                     .info(ResponseCode.UN_ERROR.getInfo())
diff --git a/big-market-types/src/main/java/cn/bugstack/types/common/Constants.java b/big-market-types/src/main/java/cn/bugstack/types/common/Constants.java
index b509f7a..d2068e0 100644
--- a/big-market-types/src/main/java/cn/bugstack/types/common/Constants.java
+++ b/big-market-types/src/main/java/cn/bugstack/types/common/Constants.java
@@ -24,6 +24,7 @@ public class Constants {
         public static String STRATEGY_AWARD_COUNT_QUERY_KEY = "strategy_award_count_query_key";
         public static String ACTIVITY_SKU_COUNT_QUERY_KEY = "activity_sku_count_query_key";
         public static String ACTIVITY_SKU_STOCK_COUNT_KEY = "activity_sku_stock_count_key_";
+        public static String ACTIVITY_SKU_COUNT_CLEAR_KEY = "activity_sku_count_clear_key_";
 
     }
 
