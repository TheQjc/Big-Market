commit bc9819a3c5430a6a2c49013716270d2aab5e4f70
Author: 小傅哥 <184172133@qq.com>
Date:   Mon Apr 29 09:28:58 2024 +0800

    fix：任务拆分

diff --git a/big-market-trigger/src/main/java/cn/bugstack/trigger/job/SendMessageTaskJob.java b/big-market-trigger/src/main/java/cn/bugstack/trigger/job/SendMessageTaskJob.java
index d3c3832..ec4795e 100644
--- a/big-market-trigger/src/main/java/cn/bugstack/trigger/job/SendMessageTaskJob.java
+++ b/big-market-trigger/src/main/java/cn/bugstack/trigger/job/SendMessageTaskJob.java
@@ -28,40 +28,54 @@ public class SendMessageTaskJob {
     private IDBRouterStrategy dbRouter;
 
     @Scheduled(cron = "0/5 * * * * ?")
-    public void exec() {
+    public void exec_db01() {
         try {
-            // 获取分库数量
-            int dbCount = dbRouter.dbCount();
+            // 设置库表
+            dbRouter.setDBKey(1);
+            dbRouter.setTBKey(0);
+            // 查询未发送的任务
+            List<TaskEntity> taskEntities = taskService.queryNoSendMessageTaskList();
+            if (taskEntities.isEmpty()) return;
+            // 发送MQ消息
+            for (TaskEntity taskEntity : taskEntities) {
+                try {
+                    taskService.sendMessage(taskEntity);
+                    taskService.updateTaskSendMessageCompleted(taskEntity.getUserId(), taskEntity.getMessageId());
+                } catch (Exception e) {
+                    log.error("定时任务，发送MQ消息失败 userId: {} topic: {}", taskEntity.getUserId(), taskEntity.getTopic());
+                    taskService.updateTaskSendMessageFail(taskEntity.getUserId(), taskEntity.getMessageId());
+                }
+            }
+        } catch (Exception e) {
+            log.error("定时任务，扫描MQ任务表发送消息失败。", e);
+        } finally {
+            dbRouter.clear();
+        }
+    }
 
-            // 逐个库扫描表【每个库一个任务表】
-            for (int dbIdx = 1; dbIdx <= dbCount; dbIdx++) {
-                int finalDbIdx = dbIdx;
-                executor.execute(() -> {
-                    try {
-                        dbRouter.setDBKey(finalDbIdx);
-                        dbRouter.setTBKey(0);
-                        List<TaskEntity> taskEntities = taskService.queryNoSendMessageTaskList();
-                        if (taskEntities.isEmpty()) return;
-                        // 发送MQ消息
-                        for (TaskEntity taskEntity : taskEntities) {
-                            // 开启线程发送，提高发送效率。配置的线程池策略为 CallerRunsPolicy，在 ThreadPoolConfig 配置中有4个策略，面试中容易对比提问。可以检索下相关资料。
-                            executor.execute(() -> {
-                                try {
-                                    taskService.sendMessage(taskEntity);
-                                    taskService.updateTaskSendMessageCompleted(taskEntity.getUserId(), taskEntity.getMessageId());
-                                } catch (Exception e) {
-                                    log.error("定时任务，发送MQ消息失败 userId: {} topic: {}", taskEntity.getUserId(), taskEntity.getTopic());
-                                    taskService.updateTaskSendMessageFail(taskEntity.getUserId(), taskEntity.getMessageId());
-                                }
-                            });
-                        }
-                    } finally {
-                        dbRouter.clear();
-                    }
-                });
+    @Scheduled(cron = "0/5 * * * * ?")
+    public void exec_db02() {
+        try {
+            // 设置库表
+            dbRouter.setDBKey(2);
+            dbRouter.setTBKey(0);
+            // 查询未发送的任务
+            List<TaskEntity> taskEntities = taskService.queryNoSendMessageTaskList();
+            if (taskEntities.isEmpty()) return;
+            // 发送MQ消息
+            for (TaskEntity taskEntity : taskEntities) {
+                try {
+                    taskService.sendMessage(taskEntity);
+                    taskService.updateTaskSendMessageCompleted(taskEntity.getUserId(), taskEntity.getMessageId());
+                } catch (Exception e) {
+                    log.error("定时任务，发送MQ消息失败 userId: {} topic: {}", taskEntity.getUserId(), taskEntity.getTopic());
+                    taskService.updateTaskSendMessageFail(taskEntity.getUserId(), taskEntity.getMessageId());
+                }
             }
         } catch (Exception e) {
             log.error("定时任务，扫描MQ任务表发送消息失败。", e);
+        } finally {
+            dbRouter.clear();
         }
     }
 
