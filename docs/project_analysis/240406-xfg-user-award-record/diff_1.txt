commit fc0213ce5bcec559e0b7cfe1ae7737c27485d688
Author: 小傅哥 <184172133@qq.com>
Date:   Sat Apr 6 16:14:03 2024 +0800

    feat: 【营销服务】第19节：写入中奖记录和任务补偿发送MQ

diff --git a/big-market-app/src/main/resources/application-dev.yml b/big-market-app/src/main/resources/application-dev.yml
index 976f518..f6debbb 100644
--- a/big-market-app/src/main/resources/application-dev.yml
+++ b/big-market-app/src/main/resources/application-dev.yml
@@ -26,6 +26,8 @@ spring:
         prefetch: 1 # 每次投递n个消息，消费完在投递n个
     topic:
       activity_sku_stock_zero: activity_sku_stock_zero
+      send_award: send_award
+
 # 线程池配置
 thread:
   pool:
diff --git a/big-market-app/src/main/resources/mybatis/mapper/task_mapper.xml b/big-market-app/src/main/resources/mybatis/mapper/task_mapper.xml
index 6003512..e4d1fd8 100644
--- a/big-market-app/src/main/resources/mybatis/mapper/task_mapper.xml
+++ b/big-market-app/src/main/resources/mybatis/mapper/task_mapper.xml
@@ -2,4 +2,43 @@
 <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="cn.bugstack.infrastructure.persistent.dao.ITaskDao">
 
+    <resultMap id="dataMap" type="cn.bugstack.infrastructure.persistent.po.Task">
+        <id column="id" property="id"/>
+        <result column="user_id" property="userId"/>
+        <result column="topic" property="topic"/>
+        <result column="message_id" property="messageId"/>
+        <result column="message" property="message"/>
+        <result column="state" property="state"/>
+        <result column="create_time" property="createTime"/>
+        <result column="update_time" property="updateTime"/>
+    </resultMap>
+
+    <insert id="insert" parameterType="cn.bugstack.infrastructure.persistent.po.UserAwardRecord">
+        insert into task(
+        user_id, topic, message_id, message, state, create_time, update_time
+        ) values (
+        #{userId},#{topic},#{messageId},#{message},#{state},now(),now()
+        )
+    </insert>
+
+    <update id="updateTaskSendMessageCompleted"
+            parameterType="cn.bugstack.infrastructure.persistent.po.UserAwardRecord">
+        update task
+        set state = 'completed', update_time = now()
+        where user_id = #{userId} and message_id = #{messageId}
+    </update>
+
+    <update id="updateTaskSendMessageFail" parameterType="cn.bugstack.infrastructure.persistent.po.UserAwardRecord">
+        update task
+        set state = 'fail', update_time = now()
+        where user_id = #{userId} and message_id = #{messageId}
+    </update>
+
+    <select id="queryNoSendMessageTaskList" resultMap="dataMap">
+        select user_id, topic, message_id, message
+        from task
+        where state = 'fail' or (state = 'create' and now() - update_time > 6)
+        limit 10
+    </select>
+
 </mapper>
diff --git a/big-market-app/src/main/resources/mybatis/mapper/user_award_record_mapper.xml b/big-market-app/src/main/resources/mybatis/mapper/user_award_record_mapper.xml
index 29e7851..d87989e 100644
--- a/big-market-app/src/main/resources/mybatis/mapper/user_award_record_mapper.xml
+++ b/big-market-app/src/main/resources/mybatis/mapper/user_award_record_mapper.xml
@@ -2,4 +2,26 @@
 <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="cn.bugstack.infrastructure.persistent.dao.IUserAwardRecordDao">
 
+    <resultMap id="dataMap" type="cn.bugstack.infrastructure.persistent.po.UserAwardRecord">
+        <id column="id" property="id"/>
+        <result column="user_id" property="userId"/>
+        <result column="activity_id" property="activityId"/>
+        <result column="strategy_id" property="strategyId"/>
+        <result column="order_id" property="orderId"/>
+        <result column="award_id" property="awardId"/>
+        <result column="award_title" property="awardTitle"/>
+        <result column="award_time" property="awardTime"/>
+        <result column="award_state" property="awardState"/>
+        <result column="create_time" property="createTime"/>
+        <result column="update_time" property="updateTime"/>
+    </resultMap>
+
+    <insert id="insert" parameterType="cn.bugstack.infrastructure.persistent.po.UserAwardRecord">
+        insert into user_award_record(
+            user_id, activity_id, strategy_id, order_id, award_id, award_title, award_time, award_state, create_time, update_time
+        ) values (
+            #{userId},#{activityId},#{strategyId},#{orderId},#{awardId},#{awardTitle},#{awardTime},#{awardState},now(),now()
+        )
+    </insert>
+
 </mapper>
diff --git a/big-market-app/src/test/java/cn/bugstack/test/domain/award/AwardServiceTest.java b/big-market-app/src/test/java/cn/bugstack/test/domain/award/AwardServiceTest.java
new file mode 100644
index 0000000..757eb26
--- /dev/null
+++ b/big-market-app/src/test/java/cn/bugstack/test/domain/award/AwardServiceTest.java
@@ -0,0 +1,52 @@
+package cn.bugstack.test.domain.award;
+
+import cn.bugstack.domain.award.model.entity.UserAwardRecordEntity;
+import cn.bugstack.domain.award.model.valobj.AwardStateVO;
+import cn.bugstack.domain.award.service.IAwardService;
+import lombok.extern.slf4j.Slf4j;
+import org.apache.commons.lang3.RandomStringUtils;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+import org.springframework.boot.test.context.SpringBootTest;
+import org.springframework.test.context.junit4.SpringRunner;
+
+import javax.annotation.Resource;
+import java.util.Date;
+import java.util.concurrent.CountDownLatch;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 奖品服务测试
+ * @create 2024-04-06 11:27
+ */
+@Slf4j
+@RunWith(SpringRunner.class)
+@SpringBootTest
+public class AwardServiceTest {
+
+    @Resource
+    private IAwardService awardService;
+
+    /**
+     * 模拟发放抽奖记录，流程中会发送MQ，以及接收MQ消息，还有 task 表，补偿发送MQ
+     */
+    @Test
+    public void test_saveUserAwardRecord() throws InterruptedException {
+        for (int i = 0; i < 100; i++) {
+            UserAwardRecordEntity userAwardRecordEntity = new UserAwardRecordEntity();
+            userAwardRecordEntity.setUserId("xiaofuge");
+            userAwardRecordEntity.setActivityId(100301L);
+            userAwardRecordEntity.setStrategyId(100006L);
+            userAwardRecordEntity.setOrderId(RandomStringUtils.randomNumeric(12));
+            userAwardRecordEntity.setAwardId(101);
+            userAwardRecordEntity.setAwardTitle("OpenAI 增加使用次数");
+            userAwardRecordEntity.setAwardTime(new Date());
+            userAwardRecordEntity.setAwardState(AwardStateVO.create);
+            awardService.saveUserAwardRecord(userAwardRecordEntity);
+            Thread.sleep(500);
+        }
+
+        new CountDownLatch(1).await();
+    }
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/award/event/SendAwardMessageEvent.java b/big-market-domain/src/main/java/cn/bugstack/domain/award/event/SendAwardMessageEvent.java
new file mode 100644
index 0000000..c8e0c31
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/award/event/SendAwardMessageEvent.java
@@ -0,0 +1,58 @@
+package cn.bugstack.domain.award.event;
+
+import cn.bugstack.types.event.BaseEvent;
+import lombok.AllArgsConstructor;
+import lombok.Builder;
+import lombok.Data;
+import lombok.NoArgsConstructor;
+import org.apache.commons.lang3.RandomStringUtils;
+import org.springframework.beans.factory.annotation.Value;
+import org.springframework.stereotype.Component;
+
+import java.util.Date;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 用户奖品记录事件消息
+ * @create 2024-04-06 09:43
+ */
+@Component
+public class SendAwardMessageEvent extends BaseEvent<SendAwardMessageEvent.SendAwardMessage> {
+
+    @Value("${spring.rabbitmq.topic.send_award}")
+    private String topic;
+
+    @Override
+    public EventMessage<SendAwardMessage> buildEventMessage(SendAwardMessage data) {
+        return EventMessage.<SendAwardMessage>builder()
+                .id(RandomStringUtils.randomNumeric(11))
+                .timestamp(new Date())
+                .data(data)
+                .build();
+    }
+
+    @Override
+    public String topic() {
+        return topic;
+    }
+
+    @Data
+    @Builder
+    @AllArgsConstructor
+    @NoArgsConstructor
+    public static class SendAwardMessage {
+        /**
+         * 用户ID
+         */
+        private String userId;
+        /**
+         * 奖品ID
+         */
+        private Integer awardId;
+        /**
+         * 奖品标题（名称）
+         */
+        private String awardTitle;
+    }
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/award/model/aggregate/UserAwardRecordAggregate.java b/big-market-domain/src/main/java/cn/bugstack/domain/award/model/aggregate/UserAwardRecordAggregate.java
new file mode 100644
index 0000000..2316aa7
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/award/model/aggregate/UserAwardRecordAggregate.java
@@ -0,0 +1,25 @@
+package cn.bugstack.domain.award.model.aggregate;
+
+import cn.bugstack.domain.award.model.entity.TaskEntity;
+import cn.bugstack.domain.award.model.entity.UserAwardRecordEntity;
+import lombok.AllArgsConstructor;
+import lombok.Builder;
+import lombok.Data;
+import lombok.NoArgsConstructor;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 用户中奖记录聚合对象 【聚合代表一个事务操作】
+ * @create 2024-04-06 09:40
+ */
+@Data
+@Builder
+@AllArgsConstructor
+@NoArgsConstructor
+public class UserAwardRecordAggregate {
+
+    private UserAwardRecordEntity userAwardRecordEntity;
+
+    private TaskEntity taskEntity;
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/award/model/entity/TaskEntity.java b/big-market-domain/src/main/java/cn/bugstack/domain/award/model/entity/TaskEntity.java
new file mode 100644
index 0000000..e60c052
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/award/model/entity/TaskEntity.java
@@ -0,0 +1,33 @@
+package cn.bugstack.domain.award.model.entity;
+
+import cn.bugstack.domain.award.event.SendAwardMessageEvent;
+import cn.bugstack.domain.award.model.valobj.TaskStateVO;
+import cn.bugstack.types.event.BaseEvent;
+import lombok.AllArgsConstructor;
+import lombok.Builder;
+import lombok.Data;
+import lombok.NoArgsConstructor;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 任务实体对象
+ * @create 2024-04-06 09:38
+ */
+@Data
+@Builder
+@AllArgsConstructor
+@NoArgsConstructor
+public class TaskEntity {
+
+    /** 活动ID */
+    private String userId;
+    /** 消息主题 */
+    private String topic;
+    /** 消息编号 */
+    private String messageId;
+    /** 消息主体 */
+    private BaseEvent.EventMessage<SendAwardMessageEvent.SendAwardMessage> message;
+    /** 任务状态；create-创建、completed-完成、fail-失败 */
+    private TaskStateVO state;
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/award/model/entity/UserAwardRecordEntity.java b/big-market-domain/src/main/java/cn/bugstack/domain/award/model/entity/UserAwardRecordEntity.java
new file mode 100644
index 0000000..67e32c0
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/award/model/entity/UserAwardRecordEntity.java
@@ -0,0 +1,39 @@
+package cn.bugstack.domain.award.model.entity;
+
+import cn.bugstack.domain.award.model.valobj.AwardStateVO;
+import lombok.AllArgsConstructor;
+import lombok.Builder;
+import lombok.Data;
+import lombok.NoArgsConstructor;
+
+import java.util.Date;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 用户中奖记录实体对象
+ * @create 2024-04-06 09:06
+ */
+@Data
+@Builder
+@AllArgsConstructor
+@NoArgsConstructor
+public class UserAwardRecordEntity {
+
+    /** 用户ID */
+    private String userId;
+    /** 活动ID */
+    private Long activityId;
+    /** 抽奖策略ID */
+    private Long strategyId;
+    /** 抽奖订单ID【作为幂等使用】 */
+    private String orderId;
+    /** 奖品ID */
+    private Integer awardId;
+    /** 奖品标题（名称） */
+    private String awardTitle;
+    /** 中奖时间 */
+    private Date awardTime;
+    /** 奖品状态；create-创建、completed-发奖完成 */
+    private AwardStateVO awardState;
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/award/model/valobj/AwardStateVO.java b/big-market-domain/src/main/java/cn/bugstack/domain/award/model/valobj/AwardStateVO.java
new file mode 100644
index 0000000..dbf3d0c
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/award/model/valobj/AwardStateVO.java
@@ -0,0 +1,23 @@
+package cn.bugstack.domain.award.model.valobj;
+
+import lombok.AllArgsConstructor;
+import lombok.Getter;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 奖品状态枚举值对象 【值对象，用于描述对象属性的值，一个对象中，一个属性，有多个状态值。】
+ * @create 2024-04-06 09:13
+ */
+@Getter
+@AllArgsConstructor
+public enum AwardStateVO {
+
+    create("create", "创建"),
+    complete("complete", "发奖完成"),
+    fail("fail", "发奖失败"),
+    ;
+
+    private final String code;
+    private final String desc;
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/award/model/valobj/TaskStateVO.java b/big-market-domain/src/main/java/cn/bugstack/domain/award/model/valobj/TaskStateVO.java
new file mode 100644
index 0000000..7c42d74
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/award/model/valobj/TaskStateVO.java
@@ -0,0 +1,23 @@
+package cn.bugstack.domain.award.model.valobj;
+
+import lombok.AllArgsConstructor;
+import lombok.Getter;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 任务状态值对象
+ * @create 2024-04-06 10:00
+ */
+@Getter
+@AllArgsConstructor
+public enum TaskStateVO {
+
+    create("create", "创建"),
+    complete("complete", "发送完成"),
+    fail("fail", "发送失败"),
+    ;
+
+    private final String code;
+    private final String desc;
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/award/repository/IAwardRepository.java b/big-market-domain/src/main/java/cn/bugstack/domain/award/repository/IAwardRepository.java
new file mode 100644
index 0000000..ca8a31a
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/award/repository/IAwardRepository.java
@@ -0,0 +1,14 @@
+package cn.bugstack.domain.award.repository;
+
+import cn.bugstack.domain.award.model.aggregate.UserAwardRecordAggregate;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 奖品仓储服务
+ * @create 2024-04-06 09:02
+ */
+public interface IAwardRepository {
+
+    void saveUserAwardRecord(UserAwardRecordAggregate userAwardRecordAggregate);
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/award/service/AwardService.java b/big-market-domain/src/main/java/cn/bugstack/domain/award/service/AwardService.java
new file mode 100644
index 0000000..892b053
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/award/service/AwardService.java
@@ -0,0 +1,55 @@
+package cn.bugstack.domain.award.service;
+
+import cn.bugstack.domain.award.event.SendAwardMessageEvent;
+import cn.bugstack.domain.award.model.aggregate.UserAwardRecordAggregate;
+import cn.bugstack.domain.award.model.entity.TaskEntity;
+import cn.bugstack.domain.award.model.entity.UserAwardRecordEntity;
+import cn.bugstack.domain.award.model.valobj.TaskStateVO;
+import cn.bugstack.domain.award.repository.IAwardRepository;
+import cn.bugstack.types.event.BaseEvent;
+import org.springframework.stereotype.Service;
+
+import javax.annotation.Resource;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 奖品服务
+ * @create 2024-04-06 09:39
+ */
+@Service
+public class AwardService implements IAwardService {
+
+    @Resource
+    private IAwardRepository awardRepository;
+    @Resource
+    private SendAwardMessageEvent sendAwardMessageEvent;
+
+    @Override
+    public void saveUserAwardRecord(UserAwardRecordEntity userAwardRecordEntity) {
+        // 构建消息对象
+        SendAwardMessageEvent.SendAwardMessage sendAwardMessage = new SendAwardMessageEvent.SendAwardMessage();
+        sendAwardMessage.setUserId(userAwardRecordEntity.getUserId());
+        sendAwardMessage.setAwardId(userAwardRecordEntity.getAwardId());
+        sendAwardMessage.setAwardTitle(userAwardRecordEntity.getAwardTitle());
+
+        BaseEvent.EventMessage<SendAwardMessageEvent.SendAwardMessage> sendAwardMessageEventMessage = sendAwardMessageEvent.buildEventMessage(sendAwardMessage);
+
+        // 构建任务对象
+        TaskEntity taskEntity = new TaskEntity();
+        taskEntity.setUserId(userAwardRecordEntity.getUserId());
+        taskEntity.setTopic(sendAwardMessageEvent.topic());
+        taskEntity.setMessageId(sendAwardMessageEventMessage.getId());
+        taskEntity.setMessage(sendAwardMessageEventMessage);
+        taskEntity.setState(TaskStateVO.create);
+
+        // 构建聚合对象
+        UserAwardRecordAggregate userAwardRecordAggregate = UserAwardRecordAggregate.builder()
+                .taskEntity(taskEntity)
+                .userAwardRecordEntity(userAwardRecordEntity)
+                .build();
+
+        // 存储聚合对象 - 一个事务下，用户的中奖记录
+        awardRepository.saveUserAwardRecord(userAwardRecordAggregate);
+    }
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/award/service/IAwardService.java b/big-market-domain/src/main/java/cn/bugstack/domain/award/service/IAwardService.java
new file mode 100644
index 0000000..362d1a2
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/award/service/IAwardService.java
@@ -0,0 +1,14 @@
+package cn.bugstack.domain.award.service;
+
+import cn.bugstack.domain.award.model.entity.UserAwardRecordEntity;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 奖品服务接口
+ * @create 2024-04-06 09:03
+ */
+public interface IAwardService {
+
+    void saveUserAwardRecord(UserAwardRecordEntity userAwardRecordEntity);
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/task/model/entity/TaskEntity.java b/big-market-domain/src/main/java/cn/bugstack/domain/task/model/entity/TaskEntity.java
new file mode 100644
index 0000000..16b0220
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/task/model/entity/TaskEntity.java
@@ -0,0 +1,22 @@
+package cn.bugstack.domain.task.model.entity;
+
+import lombok.Data;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 任务实体对象
+ * @create 2024-04-06 10:49
+ */
+@Data
+public class TaskEntity {
+
+    /** 活动ID */
+    private String userId;
+    /** 消息主题 */
+    private String topic;
+    /** 消息编号 */
+    private String messageId;
+    /** 消息主体 */
+    private String message;
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/task/repository/ITaskRepository.java b/big-market-domain/src/main/java/cn/bugstack/domain/task/repository/ITaskRepository.java
new file mode 100644
index 0000000..bb83fc0
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/task/repository/ITaskRepository.java
@@ -0,0 +1,22 @@
+package cn.bugstack.domain.task.repository;
+
+import cn.bugstack.domain.task.model.entity.TaskEntity;
+
+import java.util.List;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 任务服务仓储接口
+ * @create 2024-04-06 10:51
+ */
+public interface ITaskRepository {
+
+    List<TaskEntity> queryNoSendMessageTaskList();
+
+    void sendMessage(TaskEntity taskEntity);
+
+    void updateTaskSendMessageCompleted(String userId, String messageId);
+
+    void updateTaskSendMessageFail(String userId, String messageId);
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/task/service/ITaskService.java b/big-market-domain/src/main/java/cn/bugstack/domain/task/service/ITaskService.java
new file mode 100644
index 0000000..3312fb8
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/task/service/ITaskService.java
@@ -0,0 +1,27 @@
+package cn.bugstack.domain.task.service;
+
+import cn.bugstack.domain.task.model.entity.TaskEntity;
+
+import java.util.List;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 消息任务服务接口
+ * @create 2024-04-06 10:49
+ */
+public interface ITaskService {
+
+    /**
+     * 查询发送MQ失败和超时1分钟未发送的MQ
+     *
+     * @return 未发送的任务消息列表10条
+     */
+    List<TaskEntity> queryNoSendMessageTaskList();
+
+    void sendMessage(TaskEntity taskEntity);
+
+    void updateTaskSendMessageCompleted(String userId, String messageId);
+
+    void updateTaskSendMessageFail(String userId, String messageId);
+
+}
diff --git a/big-market-domain/src/main/java/cn/bugstack/domain/task/service/TaskService.java b/big-market-domain/src/main/java/cn/bugstack/domain/task/service/TaskService.java
new file mode 100644
index 0000000..8d9c5bd
--- /dev/null
+++ b/big-market-domain/src/main/java/cn/bugstack/domain/task/service/TaskService.java
@@ -0,0 +1,41 @@
+package cn.bugstack.domain.task.service;
+
+import cn.bugstack.domain.task.model.entity.TaskEntity;
+import cn.bugstack.domain.task.repository.ITaskRepository;
+import org.springframework.stereotype.Service;
+
+import javax.annotation.Resource;
+import java.util.List;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 消息任务服务
+ * @create 2024-04-06 10:54
+ */
+@Service
+public class TaskService implements ITaskService {
+
+    @Resource
+    private ITaskRepository taskRepository;
+
+    @Override
+    public List<TaskEntity> queryNoSendMessageTaskList() {
+        return taskRepository.queryNoSendMessageTaskList();
+    }
+
+    @Override
+    public void sendMessage(TaskEntity taskEntity) {
+        taskRepository.sendMessage(taskEntity);
+    }
+
+    @Override
+    public void updateTaskSendMessageCompleted(String userId, String messageId) {
+        taskRepository.updateTaskSendMessageCompleted(userId, messageId);
+    }
+
+    @Override
+    public void updateTaskSendMessageFail(String userId, String messageId) {
+        taskRepository.updateTaskSendMessageFail(userId, messageId);
+    }
+
+}
diff --git a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/event/EventPublisher.java b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/event/EventPublisher.java
index d527189..a672a46 100644
--- a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/event/EventPublisher.java
+++ b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/event/EventPublisher.java
@@ -30,4 +30,14 @@ public class EventPublisher {
         }
     }
 
+    public void publish(String topic, String eventMessageJSON){
+        try {
+            rabbitTemplate.convertAndSend(topic, eventMessageJSON);
+            log.info("发送MQ消息 topic:{} message:{}", topic, eventMessageJSON);
+        } catch (Exception e) {
+            log.error("发送MQ消息失败 topic:{} message:{}", topic, eventMessageJSON, e);
+            throw e;
+        }
+    }
+
 }
diff --git a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/ITaskDao.java b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/ITaskDao.java
index 355fc49..56db89a 100644
--- a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/ITaskDao.java
+++ b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/ITaskDao.java
@@ -1,9 +1,27 @@
 package cn.bugstack.infrastructure.persistent.dao;
 
+import cn.bugstack.infrastructure.persistent.po.Task;
+import cn.bugstack.middleware.db.router.annotation.DBRouter;
+import org.apache.ibatis.annotations.Mapper;
+
+import java.util.List;
+
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
  * @description 任务表，发送MQ
  * @create 2024-04-03 15:57
  */
+@Mapper
 public interface ITaskDao {
+
+    void insert(Task task);
+
+    @DBRouter
+    void updateTaskSendMessageCompleted(Task task);
+
+    @DBRouter
+    void updateTaskSendMessageFail(Task task);
+
+    List<Task> queryNoSendMessageTaskList();
+
 }
diff --git a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IUserAwardRecordDao.java b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IUserAwardRecordDao.java
index a9a951d..7e11145 100644
--- a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IUserAwardRecordDao.java
+++ b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/dao/IUserAwardRecordDao.java
@@ -1,9 +1,18 @@
 package cn.bugstack.infrastructure.persistent.dao;
 
+import cn.bugstack.infrastructure.persistent.po.UserAwardRecord;
+import cn.bugstack.middleware.db.router.annotation.DBRouterStrategy;
+import org.apache.ibatis.annotations.Mapper;
+
 /**
  * @author Fuzhengwei bugstack.cn @小傅哥
  * @description 用户中奖记录表
  * @create 2024-04-03 15:57
  */
+@Mapper
+@DBRouterStrategy(splitTable = true)
 public interface IUserAwardRecordDao {
+
+    void insert(UserAwardRecord userAwardRecord);
+
 }
diff --git a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/po/Task.java b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/po/Task.java
index c900170..b7f5a67 100644
--- a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/po/Task.java
+++ b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/po/Task.java
@@ -14,8 +14,12 @@ public class Task {
 
     /** 自增ID */
     private String id;
+    /** 活动ID */
+    private String userId;
     /** 消息主题 */
     private String topic;
+    /** 消息编号 */
+    private String messageId;
     /** 消息主体 */
     private String message;
     /** 任务状态；create-创建、completed-完成、fail-失败 */
diff --git a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/AwardRepository.java b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/AwardRepository.java
new file mode 100644
index 0000000..4348045
--- /dev/null
+++ b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/AwardRepository.java
@@ -0,0 +1,100 @@
+package cn.bugstack.infrastructure.persistent.repository;
+
+import cn.bugstack.domain.award.model.aggregate.UserAwardRecordAggregate;
+import cn.bugstack.domain.award.model.entity.TaskEntity;
+import cn.bugstack.domain.award.model.entity.UserAwardRecordEntity;
+import cn.bugstack.domain.award.repository.IAwardRepository;
+import cn.bugstack.infrastructure.event.EventPublisher;
+import cn.bugstack.infrastructure.persistent.dao.ITaskDao;
+import cn.bugstack.infrastructure.persistent.dao.IUserAwardRecordDao;
+import cn.bugstack.infrastructure.persistent.po.Task;
+import cn.bugstack.infrastructure.persistent.po.UserAwardRecord;
+import cn.bugstack.middleware.db.router.strategy.IDBRouterStrategy;
+import cn.bugstack.types.enums.ResponseCode;
+import cn.bugstack.types.exception.AppException;
+import com.alibaba.fastjson.JSON;
+import lombok.extern.slf4j.Slf4j;
+import org.springframework.dao.DuplicateKeyException;
+import org.springframework.stereotype.Component;
+import org.springframework.transaction.support.TransactionTemplate;
+
+import javax.annotation.Resource;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 奖品仓储服务
+ * @create 2024-04-06 10:09
+ */
+@Slf4j
+@Component
+public class AwardRepository implements IAwardRepository {
+
+    @Resource
+    private ITaskDao taskDao;
+    @Resource
+    private IUserAwardRecordDao userAwardRecordDao;
+    @Resource
+    private IDBRouterStrategy dbRouter;
+    @Resource
+    private TransactionTemplate transactionTemplate;
+    @Resource
+    private EventPublisher eventPublisher;
+
+    @Override
+    public void saveUserAwardRecord(UserAwardRecordAggregate userAwardRecordAggregate) {
+
+        UserAwardRecordEntity userAwardRecordEntity = userAwardRecordAggregate.getUserAwardRecordEntity();
+        TaskEntity taskEntity = userAwardRecordAggregate.getTaskEntity();
+        String userId = userAwardRecordEntity.getUserId();
+        Long activityId = userAwardRecordEntity.getActivityId();
+        Integer awardId = userAwardRecordEntity.getAwardId();
+
+        UserAwardRecord userAwardRecord = new UserAwardRecord();
+        userAwardRecord.setUserId(userAwardRecordEntity.getUserId());
+        userAwardRecord.setActivityId(userAwardRecordEntity.getActivityId());
+        userAwardRecord.setStrategyId(userAwardRecordEntity.getStrategyId());
+        userAwardRecord.setOrderId(userAwardRecordEntity.getOrderId());
+        userAwardRecord.setAwardId(userAwardRecordEntity.getAwardId());
+        userAwardRecord.setAwardTitle(userAwardRecordEntity.getAwardTitle());
+        userAwardRecord.setAwardTime(userAwardRecordEntity.getAwardTime());
+        userAwardRecord.setAwardState(userAwardRecordEntity.getAwardState().getCode());
+
+        Task task = new Task();
+        task.setUserId(taskEntity.getUserId());
+        task.setTopic(taskEntity.getTopic());
+        task.setMessageId(taskEntity.getMessageId());
+        task.setMessage(JSON.toJSONString(taskEntity.getMessage()));
+        task.setState(taskEntity.getState().getCode());
+
+        try {
+            dbRouter.doRouter(userId);
+            transactionTemplate.execute(status -> {
+                try {
+                    // 写入记录
+                    userAwardRecordDao.insert(userAwardRecord);
+                    // 写入任务
+                    taskDao.insert(task);
+                    return 1;
+                } catch (DuplicateKeyException e) {
+                    status.setRollbackOnly();
+                    log.error("写入中奖记录，唯一索引冲突 userId: {} activityId: {} awardId: {}", userId, activityId, awardId, e);
+                    throw new AppException(ResponseCode.INDEX_DUP.getCode(), e);
+                }
+            });
+        } finally {
+            dbRouter.clear();
+        }
+
+        try {
+            // 发送消息【在事务外执行，如果失败还有任务补偿】
+            eventPublisher.publish(task.getTopic(), task.getMessage());
+            // 更新数据库记录，task 任务表
+            taskDao.updateTaskSendMessageCompleted(task);
+        } catch (Exception e) {
+            log.error("写入中奖记录，发送MQ消息失败 userId: {} topic: {}", userId, task.getTopic());
+            taskDao.updateTaskSendMessageFail(task);
+        }
+
+    }
+
+}
diff --git a/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/TaskRepository.java b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/TaskRepository.java
new file mode 100644
index 0000000..f0bc454
--- /dev/null
+++ b/big-market-infrastructure/src/main/java/cn/bugstack/infrastructure/persistent/repository/TaskRepository.java
@@ -0,0 +1,63 @@
+package cn.bugstack.infrastructure.persistent.repository;
+
+import cn.bugstack.domain.task.model.entity.TaskEntity;
+import cn.bugstack.domain.task.repository.ITaskRepository;
+import cn.bugstack.infrastructure.event.EventPublisher;
+import cn.bugstack.infrastructure.persistent.dao.ITaskDao;
+import cn.bugstack.infrastructure.persistent.po.Task;
+import org.springframework.stereotype.Repository;
+
+import javax.annotation.Resource;
+import java.util.ArrayList;
+import java.util.List;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 任务服务仓储实现
+ * @create 2024-04-06 10:57
+ */
+@Repository
+public class TaskRepository implements ITaskRepository {
+
+    @Resource
+    private ITaskDao taskDao;
+    @Resource
+    private EventPublisher eventPublisher;
+
+    @Override
+    public List<TaskEntity> queryNoSendMessageTaskList() {
+        List<Task> tasks = taskDao.queryNoSendMessageTaskList();
+        List<TaskEntity> taskEntities = new ArrayList<>(tasks.size());
+        for (Task task : tasks) {
+            TaskEntity taskEntity = new TaskEntity();
+            taskEntity.setUserId(task.getUserId());
+            taskEntity.setTopic(task.getTopic());
+            taskEntity.setMessageId(task.getMessageId());
+            taskEntity.setMessage(task.getMessage());
+            taskEntities.add(taskEntity);
+        }
+        return taskEntities;
+    }
+
+    @Override
+    public void sendMessage(TaskEntity taskEntity) {
+        eventPublisher.publish(taskEntity.getTopic(), taskEntity.getMessage());
+    }
+
+    @Override
+    public void updateTaskSendMessageCompleted(String userId, String messageId) {
+        Task taskReq = new Task();
+        taskReq.setUserId(userId);
+        taskReq.setMessageId(messageId);
+        taskDao.updateTaskSendMessageCompleted(taskReq);
+    }
+
+    @Override
+    public void updateTaskSendMessageFail(String userId, String messageId) {
+        Task taskReq = new Task();
+        taskReq.setUserId(userId);
+        taskReq.setMessageId(messageId);
+        taskDao.updateTaskSendMessageFail(taskReq);
+    }
+
+}
diff --git a/big-market-trigger/pom.xml b/big-market-trigger/pom.xml
index 88055fd..54d75d5 100644
--- a/big-market-trigger/pom.xml
+++ b/big-market-trigger/pom.xml
@@ -30,6 +30,10 @@
             <groupId>org.springframework.boot</groupId>
             <artifactId>spring-boot-starter-amqp</artifactId>
         </dependency>
+        <dependency>
+            <groupId>cn.bugstack.middleware</groupId>
+            <artifactId>db-router-spring-boot-starter</artifactId>
+        </dependency>
 
         <!-- 系统模块 -->
         <dependency>
diff --git a/big-market-trigger/src/main/java/cn/bugstack/trigger/job/SendMessageTaskJob.java b/big-market-trigger/src/main/java/cn/bugstack/trigger/job/SendMessageTaskJob.java
new file mode 100644
index 0000000..f73b07a
--- /dev/null
+++ b/big-market-trigger/src/main/java/cn/bugstack/trigger/job/SendMessageTaskJob.java
@@ -0,0 +1,70 @@
+package cn.bugstack.trigger.job;
+
+import cn.bugstack.domain.task.model.entity.TaskEntity;
+import cn.bugstack.domain.task.service.ITaskService;
+import cn.bugstack.middleware.db.router.strategy.IDBRouterStrategy;
+import lombok.extern.slf4j.Slf4j;
+import org.springframework.scheduling.annotation.Scheduled;
+import org.springframework.stereotype.Component;
+
+import javax.annotation.Resource;
+import java.util.List;
+import java.util.concurrent.ThreadPoolExecutor;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 发送MQ消息任务队列
+ * @create 2024-04-06 10:47
+ */
+@Slf4j
+@Component()
+public class SendMessageTaskJob {
+
+    @Resource
+    private ITaskService taskService;
+    @Resource
+    private ThreadPoolExecutor executor;
+    @Resource
+    private IDBRouterStrategy dbRouter;
+
+    @Scheduled(cron = "0/5 * * * * ?")
+    public void exec() {
+        try {
+            // 获取分库数量
+            int dbCount = dbRouter.dbCount();
+
+            // 逐个库扫描表【每个库一个任务表】
+            for (int dbIdx = 1; dbIdx <= dbCount; dbIdx++) {
+                int finalDbIdx = dbIdx;
+                executor.execute(() -> {
+                    try {
+                        dbRouter.setDBKey(finalDbIdx);
+                        dbRouter.setTBKey(0);
+                        List<TaskEntity> taskEntities = taskService.queryNoSendMessageTaskList();
+                        if (taskEntities.isEmpty()) return;
+                        // 发送MQ消息
+                        for (TaskEntity taskEntity : taskEntities) {
+                            // 开启线程发送，提高发送效率。配置的线程池策略为 CallerRunsPolicy，在 ThreadPoolConfig 配置中有4个策略，面试中容易对比提问。可以检索下相关资料。
+                            executor.execute(() -> {
+                                try {
+                                    taskService.sendMessage(taskEntity);
+                                    taskService.updateTaskSendMessageCompleted(taskEntity.getUserId(), taskEntity.getMessageId());
+                                } catch (Exception e) {
+                                    log.error("定时任务，发送MQ消息失败 userId: {} topic: {}", taskEntity.getUserId(), taskEntity.getTopic());
+                                    taskService.updateTaskSendMessageFail(taskEntity.getUserId(), taskEntity.getMessageId());
+                                }
+                            });
+                        }
+                    } finally {
+                        dbRouter.clear();
+                    }
+                });
+            }
+        } catch (Exception e) {
+            log.error("定时任务，扫描MQ任务表发送消息失败。", e);
+        } finally {
+            dbRouter.clear();
+        }
+    }
+
+}
diff --git a/big-market-trigger/src/main/java/cn/bugstack/trigger/job/UpdateActivitySkuStockJob.java b/big-market-trigger/src/main/java/cn/bugstack/trigger/job/UpdateActivitySkuStockJob.java
index 7827b7b..b2c0ab8 100644
--- a/big-market-trigger/src/main/java/cn/bugstack/trigger/job/UpdateActivitySkuStockJob.java
+++ b/big-market-trigger/src/main/java/cn/bugstack/trigger/job/UpdateActivitySkuStockJob.java
@@ -23,7 +23,6 @@ public class UpdateActivitySkuStockJob {
     @Scheduled(cron = "0/5 * * * * ?")
     public void exec() {
         try {
-            log.info("定时任务，更新活动sku库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】");
             ActivitySkuStockKeyVO activitySkuStockKeyVO = skuStock.takeQueueValue();
             if (null == activitySkuStockKeyVO) return;
             log.info("定时任务，更新活动sku库存 sku:{} activityId:{}", activitySkuStockKeyVO.getSku(), activitySkuStockKeyVO.getActivityId());
diff --git a/big-market-trigger/src/main/java/cn/bugstack/trigger/job/UpdateAwardStockJob.java b/big-market-trigger/src/main/java/cn/bugstack/trigger/job/UpdateAwardStockJob.java
index f5b51de..d1103b7 100644
--- a/big-market-trigger/src/main/java/cn/bugstack/trigger/job/UpdateAwardStockJob.java
+++ b/big-market-trigger/src/main/java/cn/bugstack/trigger/job/UpdateAwardStockJob.java
@@ -23,7 +23,6 @@ public class UpdateAwardStockJob {
     @Scheduled(cron = "0/5 * * * * ?")
     public void exec() {
         try {
-            log.info("定时任务，更新奖品消耗库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】");
             StrategyAwardStockKeyVO strategyAwardStockKeyVO = raffleStock.takeQueueValue();
             if (null == strategyAwardStockKeyVO) return;
             log.info("定时任务，更新奖品消耗库存 strategyId:{} awardId:{}", strategyAwardStockKeyVO.getStrategyId(), strategyAwardStockKeyVO.getAwardId());
diff --git a/big-market-trigger/src/main/java/cn/bugstack/trigger/listener/ActivitySkuStockZeroCustomer.java b/big-market-trigger/src/main/java/cn/bugstack/trigger/listener/ActivitySkuStockZeroCustomer.java
index 32e913c..1532c28 100644
--- a/big-market-trigger/src/main/java/cn/bugstack/trigger/listener/ActivitySkuStockZeroCustomer.java
+++ b/big-market-trigger/src/main/java/cn/bugstack/trigger/listener/ActivitySkuStockZeroCustomer.java
@@ -27,7 +27,7 @@ public class ActivitySkuStockZeroCustomer {
     @Resource
     private IRaffleActivitySkuStockService skuStock;
 
-    @RabbitListener(queuesToDeclare = @Queue(value = "activity_sku_stock_zero"))
+    @RabbitListener(queuesToDeclare = @Queue(value = "${spring.rabbitmq.topic.activity_sku_stock_zero}"))
     public void listener(String message) {
         try {
             log.info("监听活动sku库存消耗为0消息 topic: {} message: {}", topic, message);
diff --git a/big-market-trigger/src/main/java/cn/bugstack/trigger/listener/SendAwardCustomer.java b/big-market-trigger/src/main/java/cn/bugstack/trigger/listener/SendAwardCustomer.java
new file mode 100644
index 0000000..07cdb5d
--- /dev/null
+++ b/big-market-trigger/src/main/java/cn/bugstack/trigger/listener/SendAwardCustomer.java
@@ -0,0 +1,31 @@
+package cn.bugstack.trigger.listener;
+
+import lombok.extern.slf4j.Slf4j;
+import org.springframework.amqp.rabbit.annotation.Queue;
+import org.springframework.amqp.rabbit.annotation.RabbitListener;
+import org.springframework.beans.factory.annotation.Value;
+import org.springframework.stereotype.Component;
+
+/**
+ * @author Fuzhengwei bugstack.cn @小傅哥
+ * @description 用户奖品记录消息消费者
+ * @create 2024-04-06 12:09
+ */
+@Slf4j
+@Component
+public class SendAwardCustomer {
+
+    @Value("${spring.rabbitmq.topic.send_award}")
+    private String topic;
+
+    @RabbitListener(queuesToDeclare = @Queue(value = "${spring.rabbitmq.topic.send_award}"))
+    public void listener(String message) {
+        try {
+            log.info("监听用户奖品发送消息 topic: {} message: {}", topic, message);
+        } catch (Exception e) {
+            log.error("监听用户奖品发送消息，消费失败 topic: {} message: {}", topic, message);
+            throw e;
+        }
+    }
+
+}
